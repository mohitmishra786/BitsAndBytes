#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <stdint.h>

// Function to generate a random canary value
static uint64_t generate_canary(void) {
    // Generate 64-bit random value
    uint64_t canary = 0;
    for (int i = 0; i < 8; i++) {
        canary = (canary << 8) | (rand() & 0xFF);
    }
    return canary;
}

// Initialize random seed at program start
void __attribute__((constructor)) setup_canary() {
    srand((unsigned int)time(NULL));
}

// Function to check if canary has been modified
void check_canary(uint64_t canary, uint64_t original) {
    if (canary != original) {
        fprintf(stderr, "Stack smashing detected! Program terminated.\n");
        fprintf(stderr, "Expected canary: 0x%lx\n", original);
        fprintf(stderr, "Found canary:    0x%lx\n", canary);
        exit(EXIT_FAILURE);
    }
}

void protected_function(const char* input) {
    if (input == NULL) {
        fprintf(stderr, "Invalid input provided\n");
        return;
    }

    // Generate and store canary value
    uint64_t canary = generate_canary();
    
    // Buffer for user input
    char buffer[32];
    
    // Store canary after buffer
    uint64_t *canary_location = (uint64_t*)(buffer + sizeof(buffer));
    *canary_location = canary;
    
    // Copy input - intentionally vulnerable for demonstration
    // Note: In real code, you should NEVER use strcpy without bounds checking
    printf("Copying input: %s\n", input);
    strcpy(buffer, input);
    
    // Verify canary hasn't been modified
    check_canary(*canary_location, canary);
    
    printf("Buffer contents: %s\n", buffer);
}

int main(int argc, char** argv) {
    if (argc != 2) {
        printf("Usage: %s <input_string>\n", argv[0]);
        printf("Example:\n");
        printf("  Safe:   %s \"Hello World\"\n", argv[0]);
        printf("  Unsafe: %s \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"\n", argv[0]);
        return EXIT_FAILURE;
    }
    
    printf("Running with input of length: %zu\n", strlen(argv[1]));
    protected_function(argv[1]);
    printf("Function completed successfully!\n");
    
    return EXIT_SUCCESS;
}
